# 日報システム構築の提案書

## 1. 要件整理

クライアントからの動画では、スマートフォン画面上で日報一覧や日報詳細を操作する様子が示されていました。主な機能は以下の通りです。

- **日報一覧表示**：過去の日報を日付順に表示し、過去のデータから「コピーして新規作成」、不要な日報を削除する機能。
- **日報の種類**：動画では「業務改善日報」と「現場作業日報」の2種類のテンプレートがあり、用途に応じて切り替えていました。
- **詳細入力画面**：日付、現場名、担当者、作業内容、結果、改善項目などを入力するフォーム。写真やファイルを添付する項目もあり、印刷・共有用に美しいレイアウトで出力されています。
- **コピー新規作成機能**：前日のデータを複製して新しい日報を作成し、入力の手間を削減する機能。
- **スマホファースト**：UIはモバイル画面に最適化された縦長レイアウトで、メニューやフォームが片手操作できる設計になっていました。

## 2. 使用する基盤技術

### 2.1 Lark Base（データベース）

Lark Baseはノーコードでデータを管理できるプラットフォームであり、データの一覧表示やガントチャート、カレンダーなど複数のビューを持つ柔軟なデータ管理に適しています。外部からもAPIを使ってデータを読み書きでき、ワークフローの自動化にも対応しています。このため、日報の項目をテーブルに保存し、アプリケーション側からAPI経由でCRUD操作を行うことができます。

**主な利点:**

- **多様なビュー**：Grid、Kanban、Gantt、Calendar、Gallery などの表示形式に対応し、ユーザーが見やすい形でデータを管理できる。
- **ノーコードのデータハブ**：非エンジニアでもテーブル構造を変更したり、自動化ワークフローを設定できる。
- **API連携**：外部からレコードの作成・更新・取得・削除が行え、ファイル添付も可能（APIでfile_tokenを取得して保存）。

### 2.2 クラウドインフラ（Cloudflare）

- **Cloudflare Pages + GitHub連携**：GitHub リポジトリと接続することで、プッシュするたびに自動でビルドとデプロイが実行されます。プルリクエストごとにプレビューURLが生成され、レビューや検証が簡単になります。
- **Cloudflare R2（オブジェクトストレージ）**：S3互換のオブジェクトストレージで、データ取り出し時のエグレス料金が不要です。大量の非構造化データ（現場写真など）をベンダーロックイン無しで保存でき、Cloudflare Workers と統合してエッジでの処理も可能です。
- **Cloudflare Workers/Functions**：APIリクエストの中継や認証トークンの隠蔽、Lark API との連携処理を行うサーバーレス層として利用します。Pages Functions として同じリポジトリ内に配置することができます。

## 3. システム構成案

```
                       +-----------------+
スマホ/PCブラウザ →  |  フロントエンド  |  (Next.js/React + TypeScript)
                       +-----------------+
                                │ HTTPS
                                │ fetch API
                       +-----------------+
                       | Pages Functions |  ← Cloudflare Functions
                       +-----------------+
                                │ API
         +----------------------+------------------------+
         │                                             │
   +-----------+                           +---------------------+
   | Lark Base |<----OpenAPI (REST)------>| Cloudflare R2 (写真)|
   +-----------+                           +---------------------+
         │                                             │
         │ APIトークン                                │ S3互換API
         │                                             │
      認証・連携                                 画像/添付ファイルの保存
```

### 3.1 フロントエンド

**技術スタック**：Next.js や Nuxt.js などのメジャーなフレームワークを使用して SPA/PWA を構築します。Tailwind CSS などのユーティリティフレームワークでスマホファーストのレスポンシブデザインを実現します。オフライン時の利用を考慮し、Service Worker でキャッシュすることも検討します。

- **日報一覧画面**：Lark Base から取得したレコードを日付順にリスト表示。カードのスワイプ削除や「コピーして新規作成」ボタンを実装します。
- **詳細入力フォーム**：各日報タイプごとにフォームコンポーネントを用意し、Lark Base テーブルのフィールドと同期します。入力内容をローカル状態に保持し、保存時に API を呼び出します。
- **添付機能**：画像やPDFの添付は一旦フロントエンドで圧縮し、Cloudflare R2 にアップロード後、返ってくる file_token を Lark Base の添付フィールドに保存します。

### 3.2 Pages Functions（バックエンド）

Cloudflare Pages Functions / Workers では以下を処理します：

- **認証・環境変数管理**：Lark API トークンや R2 のアクセスキーをサーバーレス環境に安全に保持し、クライアントからは直接見えないようにします。
- **APIラッパー**：フロントエンドからの REST 呼び出しに対し、Lark Base の API へ代理でリクエストを送信して結果を返します。コピー機能や削除もここでラップします。
- **画像処理とアップロード**：ユーザーが画像をアップロードした場合、Functions でファイルを受け取り、Cloudflare R2 に PUT し、生成されたオブジェクトのURLと file_token を Lark Base へ保存します。

### 3.3 Lark Base テーブル設計

各日報タイプごとにテーブルを設計します。以下は一例です。

| テーブル | 主なフィールド | 備考 |
|---------|--------------|------|
| 業務改善日報 | 日付（Date）、担当者（User）、業務内容（Text）、改善点（Text）、改善結果（Text）、添付資料（Attachment） | 添付は写真やPDF。 |
| 現場作業日報 | 日付、現場名、天候、作業内容（長文フィールド）、使用機材（Multiple select）、成果（Text）、課題（Text）、写真（Attachment） | 別テーブルで現場マスタを管理し、リンクフィールドで関連付けます。 |

レコードIDをキーとして、「コピーして新規作成」時には既存レコードの値を取得して新規レコード作成 API に渡します。

フィールドの変更や追加はLark Base側でノーコードで行い、アプリではフィールド定義を動的に取得してフォームを生成する設計にすると柔軟性が高まります。

### 3.4 CI/CD とデプロイ

- **GitHub リポジトリの準備**：フロントエンド、Functions、インフラ設定（wrangler.toml など）を含むモノレポ構成にします。
- **Cloudflare Pages の設定**：GitHub リポジトリを Pages に接続し、プッシュ時に自動ビルド・デプロイを行います。Cloudflare Pages は GitHub または GitLab と連携し、コミット毎に自動デプロイやプレビューブランチの生成が可能です。
- **環境変数の設定**：Pages の「Settings > Environment Variables」で Lark API トークン、R2 のバケット情報などを設定します。
- **R2 バケット作成**：Cloudflare 管理画面から R2 バケットを作成し、S3 互換 API キーを取得します。R2 は S3 互換 API を提供し、データのダウンロード時にエグレス料金が発生しないため、現場写真や資料の保存に適しています。

## 4. 実装手順

### 1. プロジェクトのセットアップ

- GitHub にリポジトリを作成し、Next.js（または Nuxt.js）でプロジェクトを初期化します。
- Cloudflare Pages Functions（[公式ドキュメント](https://developers.cloudflare.com/pages/functions/)参照）を有効化します。

### 2. Lark API アクセス設定

- Lark 開発者コンソールでアプリを作成し、Base 用のスコープ（`bitable:.*`）を追加します。
- アプリの認証情報（app_id、app_secret）を取得し、サーバーレス関数内でトークンを取得する処理を実装します。

### 3. データモデルの構築

- Lark Base で「業務改善日報」「現場作業日報」用のテーブルを作成し、必要なフィールドを設定します。
- フィールド ID と名前を記録し、Functions 側でマッピングします。

### 4. バックエンドの実装（Functions）

- 各種エンドポイント（GET listReports、POST createReport、POST copyReport、PUT updateReport、DELETE deleteReportなど）を実装します。
- 画像アップロード時は、受け取ったファイルを一時的に保存し、R2 にアップロード後、返却された URL と file_token を Lark Base に送信します。

### 5. フロントエンドの実装

- **日報一覧画面**：Functions の GET API からデータを取得し、リスト表示。タップイベントで編集画面へ遷移。
- **編集画面**：フォームバリデーション、画像アップロード UI、保存／コピー／削除ボタンを実装。コピー機能では既存レコードを取得し、必要なフィールドを初期値として渡します。
- **レスポンシブデザイン**：Tailwind CSS の `sm:`、`md:` などのブレイクポイントを利用してモバイル中心のレイアウトを実現します。

### 6. CI/CD の設定

- GitHub Actions を使用してテスト・リントを実行し、Cloudflare Pages へのデプロイをトリガーします。
- Pull Request ごとに Pages のプレビュー環境が自動生成されるので、ステークホルダーと画面を確認しながら改善できます。

## 5. セキュリティおよび運用上の注意

- **認証管理**：Lark API 呼び出しにはアクセス・リフレッシュトークンが必要なため、Functions にてトークンを取得・更新し、フロントエンドには公開しないよう注意します。
- **権限管理**：日報の閲覧・編集権限をLark Base側で設定し、テーブルやフィールドへのアクセス範囲を制限します。社外ユーザー向けには公開リンクや承認フローを活用すると安全です。
- **バックアップ**：R2 バケットや Lark Base データは定期的にバックアップを取り、誤操作やデータ損失に備えます。必要に応じて GitHub リポジトリのタグ付けやブランチ保護を設定します。

## 6. まとめ

上記の構成により、Lark Base をデータベースとして活用しつつスマートフォンファーストのUIを持つ日報システムを構築できます。Lark Base の柔軟なデータ管理・ワークフロー構築機能と、Cloudflare Pages のGitHub連携による自動デプロイ機能、R2 のS3互換かつエグレス無料のストレージを組み合わせることで、開発・運用コストを抑えたスケーラブルなサービスが実現できます。
